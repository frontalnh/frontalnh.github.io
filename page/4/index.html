<!DOCTYPE html>
<html class="has-navbar-fixed-top">

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
<title>Jake.Lee&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="google-site-verification" content="PgpnJMuvO-IqYWyFljnyr-tusLhJUz1VRMmECenJyHE">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">






<link rel="icon" href="/favicon.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="/css/style.css">
<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

</head>

<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                <img src="/images/logo.png" alt="" height="28">
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item " href="/archives">Archives</a>
            
            <a class="navbar-item " href="/categories">Categories</a>
            
            <a class="navbar-item " href="/tags">Tags</a>
            
            <a class="navbar-item " href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            
            <a class="navbar-item" href="https://github.com/frontalnh">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

        <section class="section">
  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-6354931397950820",
    enable_page_level_ads: true
  });
</script>

    <div class="container">
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/02/25/getting-started-with-dex/" itemprop="url">
                Getting started with DEX
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-02-25T09:56:01.000Z" itemprop="datePublished">
                4 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/dex/">dex</a><span>></span><a class="article-category-link" href="/categories/dex/blockchain/">blockchain</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                12 minutes read (About 1868 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h2><span id="what-is-dex">What is DEX?</span></h2><p><strong>DEX</strong> 란 <strong>Decentralized Exchange</strong> 의 약어로 중간자 없이 가상화폐 지갑과 지갑 사이의 p2p 교환을 해주는 것이다.</p>
<p>DEX 에서는 <code>custody</code> 즉, 누가 거래에서의 키를 보관하는가에 대한 중대한 이슈가 있으며, DEX 는 모든 교환과정에 있어 개인이 키를 소유하고 완변하게 decentralized 되 토큰의 교환을 하는 것에 그 목적이 있다.</p>
<h2><span id="basic-procedure">Basic Procedure</span></h2><p>본 프로젝트에서 DEX 의 기본적인 프로세스는 다음과 같다.</p>
<p>먼저, 브라우저 상에서 토큰의 교환을 원하는 사용자가 <strong>매도 혹은 매수 주문</strong>을 걸면, 해당 주문정보를 EIP 712 로 서명한 서명정보와 함께 전달하면, <strong>Relayer API 를 통해 해당 기록이 off-chain 상의 orderbook 에 기록</strong>되게 된다. 그 이후, orderbook 을 조회하여 여러 주문들의 쌍을 받아와 <strong>교환이 가능한 거래쌍을 선정</strong>하여 <strong>스마트 컨트랙으로 전송</strong>한다.(즉, 하나의 taker order와 하나 이상의 maker order 들을 전달하며, 모든 주문은 서명이 완료된 주문이다. 여기서, 전송을 하는 과정에 있어 주문에 필요한 다양한 정보들을 전부 parameter 로 전달하면 gas 비 문제등 많은 문제들이 존재하기 때문에, <strong>거래에 필요한 데이터를 <code>data</code> 라는 필드로 만들어 <code>OrderParam</code> 에 포함하여 전달</strong>한다.</p>
<p>또한, <strong>위 과정을 진행함에 앞서</strong> 실제 거래의 주체가 아닌 relayer 를 통해 자금을 교환하기 때문에 플랫폼에서 만들어둔 <strong>relayer account 를 approve 하여 일정 자금에 대한 사용권한을 주어야</strong> 한다.</p>
<p>스마트 컨트랙에 전달된 인자들이 들어오면, 컨트랙은 주어진 주문 쌍을 분석하여 거래를 진행하기 위한 <code>Result</code> 들의 집합으로 나누고, 해당 주문을 <code>filled</code> 라는 <code>orderHash:amount</code> 쌍에 기록한다.</p>
<p><img src="/images/dex_process.png" alt="dex process"></p>
<h2><span id="smart-contract">Smart Contract</span></h2><h4><span id="주문의-전달">주문의 전달</span></h4><p>모든 주문은 Order Server 내의 orderbook 에 기록되고, 매칭이 가능한 조합들을 모아 스마트 컨트랙트의 <code>matchOrders</code> 를 호출하며, 그 인자는 다음과 같다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OrderParam memory takerOrderParam,</span><br><span class="line">OrderParam[] memory makerOrderParams,</span><br><span class="line">OrderAddressSet memory orderAddressSet</span><br></pre></td></tr></table></figure>
<p>여기서 order param 은 주문에 필요한 maker와 taker 의 요청정보이며, 그 형태는 다음과 같다.</p>
<p>OrderParam</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct OrderParam &#123;</span><br><span class="line">    address trader;</span><br><span class="line">    uint256 baseTokenAmount;</span><br><span class="line">    uint256 quoteTokenAmount;</span><br><span class="line">    uint256 gasTokenAmount;</span><br><span class="line">    bytes32 data; # 주문정보를 조합하여 32byte 로 축약, 가스비 절약 목적</span><br><span class="line">    OrderSignature signature; # EIP 712 서명</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위에서 <code>base token</code> 과 <code>quote token</code> 이 무엇인지 헷갈릴 수 있는데, <code>taker</code>가 매도 혹은 매수를 할때 기준이 되는 토큰을 <code>base token</code>이라고 한다. 즉, <code>taker</code> 가 특 정 토큰을 구매한다고 하면 그 구매의 대상이 되는 토큰을 base token 이라고 하며, 판매를 한다고 하면, 판매의 대상이 되는 그 토큰을 quote token 이라고 한다.</p>
<p>또한 여기서 <strong>OrderSignature 는 브라우저가 생성하고자 하는 주문정보를 EIP 712 로 서명한 서명정보</strong>로 추후 스마트 컨트랙트에서 해당 사용자의 주문정보를 해시하여 위 시그내처를 통해 유효성을 검증하는 과정을 거친다.</p>
<hr>
<p><strong>인증과정에서의 데이터의 흐름</strong></p>
<p>사용자의 orderParam 쌍 =&gt; param 의 data property 에서 order rebuild =&gt; EIP712 hash 를 orderParam 의 signature 로 validate</p>
<hr>
<p>* <strong><em>여기서 signature 의 목적은 무엇일까?</em></strong></p>
<p>여기서 signature 는 사용자가 본래 요청하고자 했던 주문정보가 스마트 컨트랙트에서 체결되는 시점에도 해당 사용자가 요청한 주문과 내용이 맞는지 검증하는 것이다.</p>
<p>가령, DEX 에서 두 사용자가 거래를 진행할때 다른 사용자가 특정 사용자의 계정을 스마트컨트랙에 거래를 요청하는 경우, 주문정보가 동일하더라도 주문을 작성한 유저가 요청한 주문이 아니므로 거래가 이루어 져서는 안되며, 특정 주문내용을 바꾸어서 컨트랙트에 체결을 요청하는 등 다양한 악용을 막는 역할을 수행한다.</p>
<p>* <strong><em>EIP 712 란 무엇인가?</em></strong></p>
<p>EIP 712 란 <strong>Ethereum Improvement Proposals 712</strong> 의 약어로 이더리움에서 향후 지원하게 될 다양한 제안들중 하나이다. 과거 사용자가 어떤 거래를 함에 있어 sign 을 할때에는 sign 의 대상이 되는 message 가 hash 화 되어 존재하기 때문에, 서명을 하는 사용자가 자신이 서명하는 내용에 대해 잘 알기 힘든 문제가 있었으며, 가령 유사한 해시값을 가진 피싱 사이트로 유도하여 사이닝을 유도한다던가 하는 다양한 위험에 노출되어 있었다.</p>
<p>이를 해결하기 위해 안전하고 값이 변조되지 않는 해싱을 보장하면서도 readability 를 가질 수 있는 서명방법을 고안하게 되었으며 그 제안내용이 EIP712 에 제안되었다.</p>
<p>EIP712 를 통해 사용자는 자신이 서명하는 정보에 대해 명확하게 인지할 수 있게 된다고 볼 수 있다.</p>
<p>EIP 서명의 절차에 대해 간략하게 소개하면, 먼저 서명을 하고자 하는 데이터의 형태를 정의하는데 이러한 <code>typed structured data</code> 를 먼저 정의하는 것으로 서명이 시작된다. 데이터의 정의가 완료되면, 여러 DAPP 들 사이에 구별되기 위한 <strong>domain separator</strong> 를 정하여 서명을 검증할 스마트 컨트랙트의 주소부터 version, salt 등의 데이터로 구성된다.</p>
<p>EIP 서명이 완료되면, 사용자는 signature 를 얻게 되며 추후 스마트 컨트랙트는 주문정보를 직접 해싱하여 사용자가 제공한 signature 로 validation 을 진행하여 유효성을 검증한다.</p>
<h4><span id="거래의-체결">거래의 체결</span></h4><p>matchOrders 함수가 호출되는 시점에 매칭된 오더들의 정보가 <code>filled</code> 에 <code>orderHash:filledAmount</code> 의 mapping 형태로 기록되며, 만약 주문이 체결되었다면 기존에 있던 주문들에 새로운 주문이 발생하면서 체결이 될 것이다.</p>
<p>여기서 기존에 있던 주문을 한 사용자를 <code>maker</code> 라 칭하며, 주문을 체결하는 주문을 발생시킨 사용자를 <code>taker</code> 라 명명한다.</p>
<p>또한, 거래의 특성상 <code>taker</code> 가 넣은 주문을 만족시키는데 필요한 하나 이상의 주문이 필요하게 되므로 주문이 매칭 될 때에는 하나의 <code>taker</code> 주문에 한개 이상의 <code>maker</code> 주문이 매칭된다.</p>
<h4><span id="taker-의-매도-주문">Taker 의 매도 주문</span></h4><p><code>taker</code> 의 매도주문으로 인해 주문이 체결되는 경우의 시나리오는 다음과 같으며, n개의 거래쌍이 이루어 졌다고 전제한다.</p>
<ol>
<li>maker 가 relayer 에게 만족하는 quote token 과 maker fee, maker gas fee(maker rebate fee 는 차감한다.) 를 n번 지급한다.</li>
<li><code>taker</code> 가 <code>maker</code> 에게 만족하는 base token 을 n번 지급한다.</li>
<li><code>relayer</code> 가 <code>taker</code> 에게 만족하는 quote token 중 taker gas fee 를 제하고 1회 지급한다.</li>
</ol>
<p><img src="/images/dex_taker_sell.png" alt="dex_taker_sell"></p>
<h4><span id="taker-의-매수-주문">Taker 의 매수 주문</span></h4><p><img src="/images/dex_taker_buy.png" alt="dex_taker_buy"></p>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/02/25/getting-started-with-solidity/" itemprop="url">
                Getting started with solidity
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-02-25T06:02:34.000Z" itemprop="datePublished">
                4 months ago
            </time>
        </span>
        
                
                    <span class="column is-narrow">
                        
                            
                                4 minutes read (About 650 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <!--toc-->
<h2><span id="restricting-access">Restricting Access</span></h2><p>하나의 컨트랙트 내의 속성들은 다른 컨트랙트에서 접근 될 수 없는 것이 기본이며, <code>public</code> 키워드를 명식적으로 사용함에 따라 다른 컨트랙트에서도 접근이 가능하게 된다.</p>
<p>또다른 접근 제한자로는 <code>modifier</code> 가 있는데, 이는 특정 함수에 지정하여 해당 함수를 호출하기 전에 자격에 맞지 않으면 접근을 제한 할 수 있는 기능을 제공한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract AccessRestriction &#123;</span><br><span class="line">	modifier onlyBy(address _account)</span><br><span class="line">    &#123;</span><br><span class="line">        require(</span><br><span class="line">            msg.sender == _account,</span><br><span class="line">            &quot;Sender not authorized.&quot;</span><br><span class="line">        );</span><br><span class="line">        // Do not forget the &quot;_;&quot;! It will</span><br><span class="line">        // be replaced by the actual function</span><br><span class="line">        // body when the modifier is used.</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="data-types">Data types</span></h2><h4><span id="memory-and-storage">memory and storage</span></h4><p>solidity 에서 memory 와 storage 를 이루는 데이터 chunk 의 크기는 32bytes 이다.</p>
<p><strong>memory</strong> 란 모든 함수 call 마다 새롭게 할당되는 임시 데이터 저장소로 이 메모리에 읽기, 쓰기 등의 작업을 수행할 때마다 가스비가 올라간다.</p>
<h4><span id="variables">variables</span></h4><p>솔리디티에서 변수는 memory address 를 가르치는 포인터이다.</p>
<h4><span id="array">array</span></h4><p>solidity 에서 array 의 첫번째 인자는 그 array 의 길이값을 저장한다.</p>
<h4><span id="bytes">Bytes</span></h4><p>solidity 에서 bytes 는 동적으로 할당되는 byte array 이며, 그 크기는 32byte 이다. 또한, solidity 에서 변수는 memory address 를 가르치는 포인터이므로 해당 포인터로 부터 32 바이트를 더해주면 실제로 해당 bytes 의 값이 저장된 주소값을 얻을 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b = new bytes(32);</span><br><span class="line">add(b, 32); // b의 값이 저장된 주소값</span><br><span class="line"></span><br><span class="line">mstore(add(b, 32), x); // b=x</span><br></pre></td></tr></table></figure>
<h2><span id="events">Events</span></h2><p>Event 는 솔리디티에서 일종의 로깅의 역할을 수행한다. 이더리움 상에서 일어나는 다양한 활동들에 대한 내역을 추적하고, 사용자 데이터를 자정하기 위해 이더리움은 로그 시스템을 적용하였으며, <strong>Event</strong> 의 발생은 일종의 로그 형태로 저장된다.</p>
<p><strong>DAPP</strong> 개발자는 이더리움의 RPC 인터페이스를 통해 이러한 이벤트들을 구독할 수 있다. <strong>Topic</strong> 은 이러한 이벤트들을 찾을 수 있도록 해주며, 가령 특정 컨트랙트에서 발생한 로그들을 듣는 등의 일들을 할 수 있다.</p>
<p>여기서 각 이벤트를 정의할 때 다음과 같이 <strong>indexed</strong> 옵션을 주면, 이렇게 구독을 하는 중에 해당 속성을 읽을 수 있다. 만약 <strong>indexed</strong> 옵션을 주지 않으며, ABI 인코딩된 데이터가 내려오게 된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">contract ExampleContract &#123;</span><br><span class="line">    event ExampleEvent(</span><br><span class="line">        address indexed _from,</span><br><span class="line">        bytes32 indexed _id,</span><br><span class="line">        uint _value</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/02/24/getting-started-with-ethereum/" itemprop="url">
                Getting started with ethereum
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-02-24T02:13:39.000Z" itemprop="datePublished">
                4 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/ethereum/">ethereum</a><span>></span><a class="article-category-link" href="/categories/ethereum/blockchain/">blockchain</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                8 minutes read (About 1144 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h1><span id="getting-started-with-ethereum">Getting started with ethereum</span></h1><h2><span id="kinds-of-accounts">Kinds of accounts</span></h2><p>이더리움에는 두가지 종류의 account 가 있는데, <strong>External Account</strong> 와 <strong>Contract Account</strong> 가 그것이다.</p>
<p>먼저 <strong>External Account</strong> 는 공개키 방식의 계정이며, <strong>address 역할을 하는 public key</strong> 와 <strong>nonce</strong> 로 구성이 되며, <strong>Contract Account</strong> 는 일반적인 <strong>smart contract</strong> 이다.</p>
<p>여기서 <strong>account 와 account</strong> 사이에 자금이 이동하면 그것을 <strong>transaction</strong> 이라고 말한다.</p>
<h2><span id="transaction">Transaction</span></h2><p>이더리움에서 transaction 이란 하나의 EOA 로부터 다른 account 로 전송되는 message 를 포함한 signed data packet 을 의미하며 다음과 같은 정보들을 담고 있으며, EOA 로 부터 EOA 로 가는 경우는 이더를 송금하는 것을 내포하고, 만약 수신자가 Contract Account 라면 해당 contract 가 어떤 코드를 실행하도록 trigger 하는 것이 된다.</p>
<ul>
<li>receipient</li>
<li>signature</li>
<li>value</li>
<li>data:  which can contain the message sent to a contract</li>
</ul>
<p>여기서 data 는 contract 가 실행에 필요한 정보를 들고 있으며 Contract ABI(Application Binary Interface) 에 따라 컨트랙트와 소통한다. 이 ABI 는 외부 와컨트랙트 간의 상호작용에 필요할 뿐만 아니라 contract 간의 상호작용에도 적용된다.</p>
<p>따라서 data 는 다음의 규약에 따라 인코딩 되어 사용되며 <strong>ABI(Application Binary Interface</strong> 에 따라 정의된다.</p>
<h4><span id="함수-선택자">함수 선택자</span></h4><p>data 의 함수 시그니처의 Keccak-256 (SHA-3) hash 의 첫 4바이트는 어떤 함수를 호출할지를 나타내며 function 시그니처로 부터 도출된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.16 &lt;0.6.0;</span><br><span class="line"></span><br><span class="line">contract Foo &#123;</span><br><span class="line">  function bar(bytes3[2] memory) public pure &#123;&#125;</span><br><span class="line">  function baz(uint32 x, bool y) public pure returns (bool r) &#123; r = x &gt; 32 || y; &#125;</span><br><span class="line">  function sam(bytes memory, bool, uint[] memory) public pure &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위의 예제에서 baz 함수를 호출하고자 하는 transaction 의 data의 함수선택자는 <code>0xcdcd77c0</code> 인데 이는 method 의 id 로 ASCII format 으로 작성된 function signature 인 <code>baz(uint32,bool</code> 의 Keccak hash(sha3) 의 첫번째 4 바이트이다.</p>
<h4><span id="함수-parameter">함수 Parameter</span></h4><p>또한 해당 함수의 parameter 로 69와 true 를 제공한다면 69를 32바이트 로 패딩한 <code>0x0000000000000000000000000000000000000000000000000000000000000045</code> 가 값이 된다. <code>0x0000000000000000000000000000000000000000000000000000000000000001</code> </p>
<h4><span id="abiapplication-binary-interface">ABI(Application Binary Interface)</span></h4><p>컴퓨터 과학에서 흔히 말하는 ABI 는 <strong>두가지 종류의 binary 프로그램 모듈 사이의 인터페이스</strong>이다. 쉬운 예로는 <strong>library</strong> 와 <strong>operating</strong> 시스템의 경우가 있는데, 하나의 라이브러리는 여러 시스템 상에서 동작해야 하므로 해당 소스코드가 다양한 운영체제에서 동작하기 위해서는 약속된 인터페이스가 필요하다. 또 한 예로는 유저에 의해 실행되는 프로그램의 예가 있는데 가령 여러 운영체제에서 해당 프로그램을 실행하여도 동작하기 위해서는 이러한 ABI 가 정의되어 있어야 한다.</p>
<p>이와 같은 맥락에서 이더리움 에서의 ABI 란 특정 함수가 이더리움에서 실행되기 위한 포맷팅의 규약으로써 이해될 수 있다.</p>
<p>아래는 스마트 컨트랙트 내에서 특정 데이터를 ABI 인코딩 하는 것을 보여준다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abi.encode(&quot;AAAA&quot;)</span><br></pre></td></tr></table></figure>
<p>위 코드는 아래와 같이 3단어로 구성된 96(32byte *3) 사이즈의 바이트 문자열을 리턴한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000000000000000000000000000000000000000000000000000000020</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000000000004</span><br><span class="line">0x4141414100000000000000000000000000000000000000000000000000000000</span><br></pre></td></tr></table></figure>
<p>한 줄씩 살펴보면 먼저 첫번째 라인은 해당 문자열의 starting offset(32 in decimal) 를 32byte 문자열에 padding 한 것이며, 두번째 문자열은 인코딩 하는 데이터의 길이인 4를 32바이트 문자열에 padding 하여 나타낸다. 마지막으로 세번째 문자열은 실제 우리의 데이터인 “AAAA” 를 UTF-8 인코딩하여 32 바이트 문자열에 padding 하여 나타내어 준다.</p>
<p>위의 encoding 방식보다 다소 간편하게 인코딩을 하고 싶다면  <code>abi.encodePacked(&quot;AAAA&quot;)</code>  라는 함수를 사용할 수 있다. 이 함수는 32바이트보다 작은 문자는 그냥 해당 문자열을 바이트로 출력하고 32바이트에 padding 하지도 않는다.</p>
<p>한가지 흥미로운 사실이 있는데, <code>keccak256</code> 을 사용하여 hashing 을 할때 복수개의 인자를 전달하면 이것을 내부적으로 <code>abi.encodePacked</code> 함수로 인코딩 하여 해싱을 한다는 것이다. 현재는 복수개의 인자를 전달하면 warning 을 출력하기는 하지만, 알아두도록 하자.</p>
<p>다음은 Keccak256 에서 <code>abi.encodePacked</code> 를 사용하는 예이다. 아래의 두 hashing 은 정확히 동일한 역할을 수행한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keccak256(&quot;AAAA&quot;, &quot;BBBB&quot;, 42);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keccak256(abi.encodePacked(&quot;AAAA&quot;, &quot;BBBB&quot;, 42));</span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/02/08/getting-started-with-nginx/" itemprop="url">
                Getting started with NGINX
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-02-08T09:10:51.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/nginx/">nginx</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                17 minutes read (About 2562 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h2><span id="what-is-nginx">What is NGINX</span></h2><p>일반적으로 webserver라 하면 http 요청이 들어오면 필요한 작업을 수행하는 서버를 의미합니다.</p>
<p>즉, 브라우저에서 읽을 수 있는 html 파일 등을 전달해 주는 역할을 합니다.</p>
<p>하지만 단순한 정적파일의 제공으로는 동적 파일 렌더링등을 수행할 수 없기 때문에 webserver는 요청을 받으면 웹서버에서 요청을 받아 그 요청을 외부 프로그램에 넘겨주면, 외부 프로그램이 프로그램 파일을 읽어 html로 반환하는 단계를 거치게 되며, 이것을 CGI 라고 합니다.</p>
<p>대표적인 CGI 로는 php fpm 등이 있습니다.</p>
<p><strong>* FAST CGI(Common Gateway Interface) 란 무엇인가?</strong></p>
<p>FastCGI는 상호 작용 프로그램을 웹 서버와 통신하기 위한 바이너리 프로토콜이다.</p>
<p>FastCGI는 초기 공용 게이트웨이 인터페이스(CGI)의 변형이다.</p>
<p>FastCGI의 주 목적은 웹 서버와 CGI 프로그램 간 통신 시 발생되는 부하를 줄임으로써 서버가 한 번에 더 많은 웹 페이지 요청을 관리할 수 있게 하는 것이다.</p>
<p><strong>* php-fpm</strong></p>
<p>nginx가 요청을 받아 php인 경우 cgi 인 php fpm에게 요청을 전달하고 거기서 php 코드를 실행한 뒤에 요청을 다시 받아온다.</p>
<h2><span id="forward-proxy-amp-reverse-proxy">Forward Proxy &amp; Reverse Proxy</span></h2><p>NGINX 는 Web Server 로써 일반적으로 기업에서 서비스를 배포할 때 reverse proxy server의 역할을 수행한다.</p>
<p>Nginx 에 대해 설명하기 전에 먼저  forward proxy 와 reverse proxy의 개념부터 설명하고자 한다.</p>
<p>먼저, <strong>forward proxy server</strong>란  사용자가 원하는 정보를 좀 더 빨리 받게 하기 위해 중간에 요청을 가로채는 것이라 볼 수 있다. 가령 target.com 이라는 주소로 어떤 정보를 받아오고 싶은 유저가 있다고 생각해 보자.</p>
<p>이 유저는 주소창에 target.com 을 입력하고 데이터를 받아올 것이며, 이 유저는 자신이 보고 있는 정보가 target.com 에서 보낸 정보라고 생각할 것이다. 하지만 대부분의 경우 유저가 받아온 정보는 실제로 target.com에 있는 정보가 아닌 중간의 프록시 서버에서 이전에 받아놓은 target.com 의 정보를 전달해 주는 것이다.</p>
<p>이러한 proxy server 는 많은 이점을 제공해 주는데, 가령 우리가 목적으로 하는 target.com 의 경우 우리의 ip 주소에 대해서는 알수가 없고, 우리가 사용하는 proxy  서버의 url 에 대해서만 알 수 있다.(하지만 대부분의 경우 browser가 우리의 정보를 제공하기 때문에 사실상은 다 알수 있다..!)</p>
<p>또한, proxy server 는 이미 알고 있는 정보에 대해서 해당 데이터를 cache 하기 때문에 추가적인 요청 없이 바로 우리에게 원하는 정보를 전달해주기 때문제 네트워크 속도의 관점에서도 더욱 빠르게 동작한다.</p>
<p><strong>NGINX</strong> 는 이러한 forward proxy 의 기능도 수행할 수 있지만, 대부분의 경우 <strong>reverse proxy</strong> 의 용도로 사용되는데, 이는 http server 의 보안 문제 해결과 로그 수집 등 여러 이점을 가지기 때문에 사용된다.</p>
<p>가령, 사용자는 proxy.com 이라는 url 로 요청을 주고 실제 서버의 위치인 target.com url 을 유저로 부터 접근을 불가능 하게 막고, 해당 서버를 VPN 에 구성함으로써 보안을 높일 수 있다.</p>
<h2><span id="how-does-it-works">How does it works?</span></h2><p>NGINX 서버는 nginx 그룹의 nginx 라는 유저로 모든 프로세스를 실행한다.</p>
<p>요청이 들어오면 nginx 는 해당 요청의 hostname 을 보고 설정된 서버들 중 어떤 서버를 사용할지 선택한다.</p>
<p>NGINX 에는 다양한 서버 설정을 할 수 있으며 이는 <code>/etc/nginx/conf.d/</code> 디렉토리에 수많은 conf 파일의 설정들 중에 어떤 서버 설정을 사용할지 결정하는데 있어 hostname 을 사용한다.</p>
<p>여기서 일치하는 hostname이 있다면 해당 설정대로 serving 하되, 만약 일치하는 hostname 이 없다면 <code>default server</code> 를 사용하며 이는 다음과 같이 server 에서 listen 하는 설정에 <code>default_server</code> 태그가 붙어있는 서버를 선택한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      80 default_server;</span><br><span class="line">    server_name example.net www.example.net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>어떤 서버로 부터 serving 할지 결정되었다면, nginx 는 url 패스를 읽어들이고 이를 location 과 비교하여 일치하는 리소스를 찾는 작업을 거치게 된다. 때문에, nginx 에는 여러개의 location 을 설정할 수 있으며, 이 중에서 가장 긴 location path를 우선적으로 선택하게 된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name localhost</span><br><span class="line">    </span><br><span class="line">    location /path &#123;</span><br><span class="line">        root /var/www/example;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="where-to-save-resources">Where to save resources</span></h3><p>서버란 특정 리소스를 제공해주는 역할을 하며, 때문에 서버가 제공할 리소스를 저장하는 공간이 필요하다.</p>
<p>nginx 는 기본적으로 <code>/usr/share/nginx</code> 디렉토리 내에 기본적이 리소스들을 보관한다.</p>
<p>하지만, 해당 디렉토리의 리소스들은 nginx 가 전역적으로 사용하기 위한 <code>50x.html</code> 과 같은 에러 페이지 리소스 등을 비롯한 nginx 어플리케이션 레벨에서의 리소스를 저장하는 공간이므로 실제 서버의 리소스는 이곳에 보관하지 않도록 한다.</p>
<p>대신, <code>/var/www/example.com/</code> 디렉토리를 컨벤션으로 사용한다.</p>
<h2><span id="basic-configuration">Basic Configuration</span></h2><p>NGINX 의 세부 설정은 /etc/nginx/nginx.conf 파일에서 관리된다.</p>
<p>하지만, 이 설정파일은 NGINX 서버 자체에 대한 설정파일로써 웹서비스를 서비스한다면 이 환경 설정은 반드시 <code>etc/nginx/conf.d/example.com.conf</code> 과 같은 파일에 설정을 해야 한다.</p>
<p><code>nginx.conf</code> 파일에서는 nginx 에서 발생하는 error 및 access log 의 저장 위치를 설정하고, 설정파일들의 위치를 명시하여 다른 설정파일을 적용하는 등, 특정 server에 종속된 것이 아니라 nginx 어플리케이션 자체의 설정을 해 준다.</p>
<p>간혹 apache 서버를 사용하던 유저들은  아파치 서버 양식인 <code>/etc/apache/sites-available</code> 와 유사하게 <code>etc/nginx/sites-available</code> 에 서버 설정을 하는 경우가 있는데 이는 좋지 않은 패턴이니 지양하도록 한다.</p>
<p>nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  auto;</span><br><span class="line"></span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line"></span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server_tokens       off;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>기본적으로 nginx 는 <code>/etc/nginx/conf.d/default.conf</code>  에서 최초의 웹 서버 설정을 해주는데, 별도의 설정파일을 추가한 이후에는 <code>default.conf</code> 파일을 제거하거나 중복된 설정을 없애 주어야 한다. 그렇지 않으면 해당 파일이 default configuration 으로 동작하여 사용자가 한 설정을 덮어써서 설정 내용이 반영이 되지 않게 된다.</p>
<p>개발자는 다음과 같이 example.com.conf 와 같은 설정파일을 작성할 수 있으며 여러 개의 서버와 location 을 지정하고, error page 및 proxy 등 다양한 설정을 할 수 있다.</p>
<p>/etc/nginx/conf.d/example.com.conf </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    </span><br><span class="line">    error_page     500 502 503 504 /50x.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass localhost:80</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &apos;upgrade&apos;;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /50x.html &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gzip             on;</span><br><span class="line">    gzip_comp_level  3;</span><br><span class="line">    gzip_types       text/plain text/css application/javascript image/*;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="serving-static-file-and-access-to-local-file-system">Serving static file and access to local file system</span></h3><p>다음과 같이 특정 url 에 파일 시스템 경로를 mapping 함으로써 특정 url 이 정적 파일들을 서빙하게 할 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location /images &#123;</span><br><span class="line">        root /var/data/images</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 코드는 /image 로 오는 요청을 file system 에 매핑하여 요청자가 직접 file system 경로를 통해 리소스를 받아올 수 있게 해준다. 만약 특정 파일 형태만 정적 파일 시스템에 접근하도록 하고 싶은 경우 다음과 같이 regular expression 을 통해 해결 할 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    location ~\.(gif|jpg|png) &#123;</span><br><span class="line">        root /var/data/images</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="reverse-proxy">Reverse Proxy</span></h3><p>NGINX 서버는 간편하게 Reverse Proxing 을 할 수 있게 해 주며, 다음과 같은 간단한 설정을 통해 reverse proxy 서버를 구축할 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name   localhost default_server;</span><br><span class="line"></span><br><span class="line">    location /example1/proxy &#123;</span><br><span class="line">        proxy_pass http://naver.com;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &apos;upgrade&apos;;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_cache_bypass $http_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위 예제는 <code>localhost/example1/proxy</code> 로 들어온 요청을 <code>http://naver.com/example1</code> 로 proxing 해주는 설정파일이다.</p>
<h3><span id="subdomain">Subdomain</span></h3><p>서비스를 출시할때 흔히 다음과 같은 서브 도메인 양식을 가지고 리소스에 접근할 필요가 있게 된다. </p>
<p>가령 관리자 페이지를 위한 admin.example.com 이라던가 혹은 개발서버를 위한 dev.example.com 과 같이 여러 subdomain 이 필요하게 된다. nginx 는 host name 을 인식하여 간편하게 subdomain 을 reverse proxing 해주며 다음과 같은 세팅을 통해 간편하게 이를 적용할 수 있다.</p>
<p>다음 예제는 localhost 환경에서 앞에 example1 이라는 prefix 를 주고, 이를 reverse proxing 해주는 설정파일이다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name example.localhost</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        root /var/www/example2.com;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="ssl">SSL</span></h3><p>많은 서비스들은 http 프로토콜의 보안을 위해 https 프로토콜을 사용하며 이를 위해서는 443 port 를 통한 SSL 레벨에서의 통신이 필요하다.</p>
<p>이러한 요청을 처리하기 위해서는 다음과 같이 443 port 를 ssl 레벨에서 listen 해야 한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    listen [::]:80;</span><br><span class="line">    listen [::]:443 ssl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="gzip">GZIP</span></h3><p>NGINX 는 통신시에 데이터를 줄이기 위해 gzip 압축을 통한 리소스 압축을 제공한다.</p>
<p>이는 다음과 같은 설정을 통해 할 수 있다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	...</span><br><span class="line">    gzip             on;</span><br><span class="line">    gzip_comp_level  3;</span><br><span class="line">    gzip_types       text/plain text/css application/javascript image/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/29/getting-started-with-aws-cli/" itemprop="url">
                Getting started with AWS cli
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-29T06:45:00.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/aws-cli/">aws-cli</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                6 minutes read (About 859 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <p>AWS 에는 수많은 기능이 있고, 이를 실제 웹사이트에서 console 을 통해 제어하는 것은 개발자에게 매우 비효율적인 일이 아닐 수 없다. AWS 는 이렇게 사용자의 컴퓨터에서 AWS 상의 많은 기능을 제어하기 위해 AWS CLI 프로그램을 제공하며, 본 포스트에서는 AWS CLI 의 기본적인 사용법을 알아보고자 한다.</p>
<h2><span id="installation">Installation</span></h2><h3><span id="mac">Mac</span></h3><p>Mac OS 에서는 다음과 같이 pip 명령어를 통해 aws cli 를 쉽게 설치할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install awscli</span><br></pre></td></tr></table></figure>
<h3><span id="ubuntu">Ubuntu</span></h3><h2><span id="authentication">Authentication</span></h2><p>AWS 는 현재 cli 프로그램을 사용하는 내가 어떤 유저인지 모르기 때문에 이를 AWS 에게 알려주어야 하며, 그것이 authentication 자체이다.</p>
<p>사용자의 PC에는 여러 AWS 유저들에 대한 정보를 저장할 수 있는데, AWS 는 매우 복잡한 유저 관리 체계를 가지기 때문에 이는 매우 필요한 일이다.(가령 특정 AWS 서비스의 조작을 위한 별도 Program user 를 생성하는 경우 여러 개발자가 하나의 계정을 공유하여 사용하는 것은 매우 빈번한 일이다.)</p>
<p><strong>Command 를 입력할 때 특정 사용자임을 밝히기</strong></p>
<p>아래 명령어를 통해 aws access key 와 secret key 를 등록하고 사용할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br></pre></td></tr></table></figure>
<p>다음과 같은 command option 을 통해 내가 어떤 사용자인지 알리고, 미리 configure 되어있는 해당 사용자의 정보로 authentication 을 진행할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws [<span class="built_in">command</span>] --profile 사용자이름</span><br></pre></td></tr></table></figure>
<p><strong>MFA 를 사용하는 경우의 인증</strong></p>
<p>콘솔 계정의 경우 cli 를 통한 작업을 진행할 경우 MFA 를 적용했다면 Access Deny 된다.</p>
<p>이 경우 MFA 유저를 위해 별도의 임시 인증을 거쳐야 하는데 이는 다음 명령어로 해결이 가능하다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-session-token --serial-number &lt;arn-mfa-device&gt; --token-code 126355 --profile jee</span><br></pre></td></tr></table></figure>
<p><code>arn-mfa-device</code> 는 각 AWS계정 정보에 들어가서 보안자격증명 탭에 할당된 MFA 디바이스를 보시면 알 수 있다.</p>
<p><code>token-code</code> 는 Authy와 같은 2FA 토큰 값을 입력해 주면 된다. </p>
<p>커맨드를 실행하시면 임시 Access Key가 발급되고 Access ID, Secret Access Key, Session Token을 환경변수나 credential에 profile로 등록하신후 사용하면 된다.</p>
<p>때문에, 만료시간이 있기때문에 매번 재발급받아야하는데 AWS에서는 이를 각자 Cron Tab등으로 만들어서 사용하는 것을 권장한다.</p>
<p>다음과 같이 credential 에 등록하여 사용하면 된다.</p>
<p>~/.aws/credential</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[profile name]</span><br><span class="line">AWS_ACCESS_KEY_ID = &lt;aws_access_key_id&gt;</span><br><span class="line">AWS_SECRET_ACCESS_KEY = &lt;aws_secret_access_key&gt;</span><br><span class="line">AWS_SESSION_TOKEN = &lt;asw_session_token&gt;</span><br></pre></td></tr></table></figure>
<h2><span id="configuration">Configuration</span></h2><p>AWS 사용자 및 기타 전역 설정에 대한 정보는 /.aws 의 config 파일에 저장되어 있다.</p>
<p>해당 파일을 열어보면 다음과 같이 세팅되어 있다.</p>
<p>config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[profile user1]</span><br><span class="line">aws_access_key_id = XXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">region = ap-northeast-2</span><br><span class="line"></span><br><span class="line">[default]</span><br><span class="line">region = ap-northeast-2</span><br></pre></td></tr></table></figure>
<p>그 중에서도 유저 정보는 credentials 에 다음과 같이 저장되어 있다.</p>
<p>~/.aws/credentials</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = XXXXXXXXXXXXXXXXXXXX</span><br><span class="line">aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">region = ap-northeast-2</span><br><span class="line"></span><br><span class="line">[&lt;profile_name&gt;]</span><br><span class="line">aws_access_key_id = XXXXXXXXXXXXXXXXXXXX</span><br><span class="line">aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>
<p>이처럼 기본 user 인 [default] 유저와 특정 유저를 나타내는 [profile user_name] 이 나뉘어 있다.</p>
<p>여기에 정의된 특정 profile 은 command line 에서 <code>--profile user1</code> 과 같이 사용될 수 있다.</p>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/29/getting-started-with-aws/" itemprop="url">
                Getting started with AWS
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-29T06:45:00.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/aws-cli/">aws cli</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                11 minutes read (About 1665 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h2><span id="route53">Route53</span></h2><p>Route53 은 AWS 가 제공하는 DNS 서비스이며, 실제 도메인을 구입하고 도메인의 routing 을 설정하고 subdomain 지정 등 많은 일을 수행할 수 있다.</p>
<p>Route 53은 도메인과 동일한 이름의 퍼블릭 호스팅 영역을 자동으로 생성한다. 퍼블릭 호스팅 영역이란 특정 도메인(예: example.com)과 그 하위 도메인(apex.example.com, acme.example.com)의 트래픽을 인터넷에서 라우팅하는 방식에 대한 정보를 담고 있는 컨테이너로, 호스팅 영역에 레코드를 생성하여 도메인 및 하위 도메인에 대한 트래픽의 라우팅 방법을 지정한다.</p>
<p>트래픽을 리소스로 라우팅하려면 호스팅 영역에 <strong>리소스 레코드 세트</strong> 라고도 하는 <em>레코드</em>를 생성해야 합니다. 각각의 레코드에는 도메인의 트래픽을 라우팅할 방법에 관한 다음과 같은 정보가 포함되어 있습니다.</p>
<p><strong>이름</strong></p>
<p>레코드의 이름은 Route 53을 사용하여 트래픽을 라우팅하려는 도메인 이름(예: example.com) 또는 하위 도메인 이름(예: <a href="http://www.example.com)과" target="_blank" rel="noopener">www.example.com)과</a> 일치합니다.</p>
<p>호스팅 영역에 있는 모든 레코드의 이름은 반드시 호스팅 영역의 이름으로 끝나야 합니다. 예를 들어 호스팅 영역의 이름이 example.com이라면 모든 레코드 이름이 example.com으로 끝나야 합니다. Route 53 콘솔은 자동으로 이 작업을 수행합니다.</p>
<p><strong>형식</strong></p>
<p>레코드 유형은 일반적으로 트래픽을 라우팅할 리소스 유형을 결정합니다. 예를 들어 트래픽을 이메일 서버로 라우팅하려면 [Type]을 [MX]로 지정합니다. IPv4 IP 주소를 가진 웹 서버로 트래픽을 라우팅하려면 [Type]을 [A]로 지정합니다.</p>
<p><strong>값</strong></p>
<p>[Value]는 [Type]과 밀접한 관련이 있습니다. [Type]을 [MX]로 지정하는 경우, [Value]에 하나 이상의 이메일 서버의 이름을 지정해야 합니다. [Type]을 [A]로 지정하는 경우, 192.0.2.136과 같은 IPv4 형식의 IP 주소를 지정해야 합니다.</p>
<p><img src="/images/image-20190328112743282.png" alt="image-20190328112743282"></p>
<p>* 출처: <a href="https://docs.aws.amazon.com/ko_kr/Route53/latest/DeveloperGuide/welcome-dns-service.html" target="_blank" rel="noopener">AWS 홈페이지</a></p>
<h2><span id="load-balancer">Load balancer</span></h2><p>Route53 에서 라우팅 된 요청을 여러 인스턴스에 분배해주는 부하 부산기이다.</p>
<p>로드 밸런서는 특정 서브도메인을 특정 타겟 그룹으로 보내도록 설정할 수 있으며, 이는 로드밸런서가 특정 프로토콜 통신을 위해 듣고 있는 포트의 rule 을 바꾸어 줌으로써 해결할 수 있다. 가령 80 번 포트 리스너에서 특정 서브 도메인을 특정 타겟 그룹으로 전달 할 수 있으며, 이때 반드시 타겟 그룹을 미리 설정해 두어야 한다.</p>
<p>타겟 그룹은 여러 인스턴스들과 특정 포트를 등록해 두는 것으로 이를 통해 로드 밸런서가 특정 타겟 그룹의 여러 인스턴스들에게 부하를 분산해서 할당한다.</p>
<h2><span id="aws-cli">AWS CLI</span></h2><p>AWS 에는 수많은 기능이 있고, 이를 실제 웹사이트에서 console 을 통해 제어하는 것은 개발자에게 매우 비효율적인 일이 아닐 수 없다. AWS 는 이렇게 사용자의 컴퓨터에서 AWS 상의 많은 기능을 제어하기 위해 AWS CLI 프로그램을 제공하며, 본 포스트에서는 AWS CLI 의 기본적인 사용법을 알아보고자 한다.</p>
<h3><span id="installation">Installation</span></h3><p>Mac OS 에서는 다음과 같이 pip 명령어를 통해 aws cli 를 쉽게 설치할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install awscli</span><br></pre></td></tr></table></figure>
<h3><span id="authentication">Authentication</span></h3><p>AWS 는 현재 cli 프로그램을 사용하는 내가 어떤 유저인지 모르기 때문에 이를 AWS 에게 알려주어야 하며, 그것이 authentication 자체이다.</p>
<p>사용자의 PC에는 여러 AWS 유저들에 대한 정보를 저장할 수 있는데, AWS 는 매우 복잡한 유저 관리 체계를 가지기 때문에 이는 매우 필요한 일이다.(가령 특정 AWS 서비스의 조작을 위한 별도 Program user 를 생성하는 경우 여러 개발자가 하나의 계정을 공유하여 사용하는 것은 매우 빈번한 일이다.)</p>
<p><strong>Command 를 입력할 때 특정 사용자임을 밝히기</strong></p>
<p>아래 명령어를 통해 aws access key 와 secret key 를 등록하고 사용할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws configure</span><br></pre></td></tr></table></figure>
<p>다음과 같은 command option 을 통해 내가 어떤 사용자인지 알리고, 미리 configure 되어있는 해당 사용자의 정보로 authentication 을 진행할 수 있다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws [<span class="built_in">command</span>] --profile 사용자이름</span><br></pre></td></tr></table></figure>
<p><strong>MFA 를 사용하는 경우의 인증</strong></p>
<p>콘솔 계정의 경우 cli 를 통한 작업을 진행할 경우 MFA 를 적용했다면 Access Deny 된다.</p>
<p>이 경우 MFA 유저를 위해 별도의 임시 인증을 거쳐야 하는데 이는 다음 명령어로 해결이 가능하다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws sts get-session-token --serial-number &lt;arn-mfa-device&gt; --token-code 126355 --profile jee</span><br></pre></td></tr></table></figure>
<p><code>arn-mfa-device</code> 는 각 AWS계정 정보에 들어가서 보안자격증명 탭에 할당된 MFA 디바이스를 보시면 알 수 있다.</p>
<p><code>token-code</code> 는 Authy와 같은 2FA 토큰 값을 입력해 주면 된다.</p>
<p>커맨드를 실행하시면 임시 Access Key가 발급되고 Access ID, Secret Access Key, Session Token을 환경변수나 credential에 profile로 등록하신후 사용하면 된다.</p>
<p>때문에, 만료시간이 있기때문에 매번 재발급받아야하는데 AWS에서는 이를 각자 Cron Tab등으로 만들어서 사용하는 것을 권장한다.</p>
<p>다음과 같이 credential 에 등록하여 사용하면 된다.</p>
<p>~/.aws/credential</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[profile name]</span><br><span class="line">AWS_ACCESS_KEY_ID = ~</span><br><span class="line">AWS_SECRET_ACCESS_KEY = ~</span><br><span class="line">AWS_SESSION_TOKEN = ~</span><br></pre></td></tr></table></figure>
<h3><span id="configuration">Configuration</span></h3><p>AWS 사용자 및 기타 전역 설정에 대한 정보는 /.aws 의 config 파일에 저장되어 있다.</p>
<p>해당 파일을 열어보면 다음과 같이 세팅되어 있다.</p>
<p>config</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[profile user1]</span><br><span class="line">aws_access_key_id = XXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br><span class="line">region = ap-northeast-2</span><br><span class="line"></span><br><span class="line">[default]</span><br><span class="line">region = ap-northeast-2</span><br></pre></td></tr></table></figure>
<p>그 중에서도 유저 정보는 credentials 에 다음과 같이 저장되어 있다.</p>
<p>credentials</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[default]</span><br><span class="line">aws_access_key_id = XXXXXXXXXXXXXXXXXXXX</span><br><span class="line">aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span><br></pre></td></tr></table></figure>
<p>이처럼 기본 user 인 [default] 유저와 특정 유저를 나타내는 [profile user_name] 이 나뉘어 있다.</p>
<p>여기에 정의된 특정 profile 은 command line 에서 <code>--profile user1</code> 과 같이 사용될 수 있다.</p>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/25/getting-started-with-elastic-stack/" itemprop="url">
                Getting started with elastic stack
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-25T01:25:12.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/elastic-stack/">elastic stack</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                21 minutes read (About 3095 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h2><span id="why-elastic-stack">Why elastic stack?</span></h2><p>기업의 서비스의 복잡도가 올라감에 따라 프록시 서버, 인증서버, 데이터베이스, api 서버 등 수많은 서비스들이 동작하고, 각자 다른 배포환경에서 관리되게 되었다. 이에 따라 하나의 서비스를 운영하더라도 여러 도메인에 걸쳐 많은 문제들이 생기게 되고, 여러 서버에 걸쳐 로그 및 데이터 분석의 필요성이 생겼고, 데이터를 관리하고 활용하기 위한 통합 솔루션의 필요성이 대두되었다. <strong>Elastic Stack</strong> 은 기업이 서비스를 운영함에 따라 나오는 모든 데이터를 한 곳에서 관리하고, 사용자가 직관적으로 이해할 수 있도록 시각화 시켜 가공하고, 수많은 데이터에서 원하는 데이터를 검색 및 분류해주는 플랫폼이다.</p>
<p>쉽게 이야기 하면, 기업이 운영하는 수십대의 서버 및 데이터베이스에서 나오는 모든 데이터를 한곳으로 모으고, 가공하고, 시각화해주는 통합 솔루션이라 할 수 있다.</p>
<p>이러한 기능을 수행하기 위해 <strong>elastic stack</strong> 을 구성하는 여러 서비스가 있는데, 대표적으로 각 서버에서 생기는 데이터를 한 곳으로 모으는 shipping 을 담당하는 <strong>beats</strong>(beat 에는 file beat 등 여러 종류의 beat 가 있으며, 기본적으로 file beat 를 사용하면 기업의 데이터 파일을 한곳으로 간편하게 이동시킬 수 있다.)와 데이터를 저장하고 분류하는 일종의 데이터 검색 엔진인 <strong>elastic search</strong> , 또, 이러한 사용자에게 가시적으로 보여주기 위한 <strong>kibana</strong> 등이 있다.</p>
<p>본 포스트에서는 이러한 elastic stack 의 다양한 기술을 활용하여 여러 서버의 로그 정보를 한 곳에 모으고 이를 모니터링 하기 위한 환경을 구축해 보도록 하겠다.</p>
<h2><span id="file-beat">File beat</span></h2><p>먼저 각 서버에서 나오는 로그들을 한곳으로 shipping 하기 위해서, 각 서버에 file beat 를 설치하고 운영해야 한다.</p>
<p>본 포스트에서는 각 서버와 filebeat 를 하나의 docker-compose 로 관리하여 하나의 서버에서 filefbeat 와 application 서버를 구축하고 이를 elastic search 서버로 전달해 보도록 한다.</p>
<p>어플리케이션 서버와 file beat 를 구성하는 docker-compose 파일은 다음과 같다.</p>
<p>docker-compose.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  filebeat:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/beats/filebeat:$&#123;ELASTIC_VERSION:-6.5.0&#125;</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">'<span class="template-variable">&#123;&#123;.Node.Hostname&#125;&#125;</span>-filebeat'</span></span><br><span class="line"><span class="attr">    user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/lib/docker/containers/:/var/lib/docker/containers/:ro</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./log/application:/var/log/application</span></span><br><span class="line"></span><br><span class="line"><span class="attr">    command:</span> <span class="string">['--strict.perms=false']</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">global</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  server:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">'example-server'</span></span><br><span class="line"><span class="attr">    build:</span> <span class="string">'./example-server'</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./log:/app/log</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">default</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">'3001:3001'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  default:</span></span><br><span class="line"><span class="attr">    driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<p>파일비트가 수집할 로그가 있는 디렉토리를 docker volume 으로 지정하고 application server 를 3001 번에서 동작시켰다.</p>
<p>또한, filebeat 의 설정을 담당하는 filebeat.yml 파일을 docker 내에 볼륨으로 지정하였으며, 그 내용은 다음과 같다.</p>
<p>filebeat.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">example</span> <span class="string">filebeat</span></span><br><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">  - type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">/var/log/application/*.log</span></span><br><span class="line"></span><br><span class="line"><span class="string">output.elasticsearch:</span></span><br><span class="line"><span class="attr">  hosts:</span> <span class="string">['host.docker.internal:9200']</span></span><br><span class="line"></span><br><span class="line"><span class="string">setup.kibana:</span></span><br><span class="line"><span class="attr">  host:</span> <span class="string">'host.docker.internal:5601'</span></span><br></pre></td></tr></table></figure>
<p>위처럼 9200번 포트에서 동작하는 elastic search 서버와 5601번에서 동작하는 kibana가 세팅된다.</p>
<h3><span id="deploy-with-beanstalk">deploy with beanstalk</span></h3><p>Beanstalk 에서 multidocker deploy를 위한 Dockerrun.aws.json 파일을 작성하여 다음과 같이 배포할 수 있다.</p>
<p>여기서 중요한 점은 image 를 배포함에 있어 반드시 <code>사용자id.dkr.ecr.ap-northeast-2.amazonaws.com/레포이름:latest</code> 의 형태로 이미지 경로를 지정해 주어야 한다는 것이다.</p>
<p>즉, 멀티 도커를 사용할 때 필요한 이미지들을 미리 아마존의 repository 에 배포해 놓아야 한다.</p>
<p>이 과정에서 반드시 아마존에 로그인이 되어야 하며, 다음과 같은 명령어를 통해 ecr 에 별도로 로그인을 수행한다.</p>
<p>아래 명령어는 기본 aws 유저가 아닌 eb cli 접근이 가능한 프로그램 유저를 설정해 두고 해당 유저의 정보로 로그인을 함을 의미한다. 아래 명령어를 입력하면 AWS 에서 로그인을 하기 위한 명령어를 output 으로 제공하는데 해당 문자열을 복사하여 다시 cli에 입력하면 로그인이 완료된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aws ecr get-login --no-include-email --profile eb-cli</span><br></pre></td></tr></table></figure>
<p>여기서 memory 는 매우 중요한데, 만약 memory 가 부족하다면 도커 컨테이너가 아무런 에러도 출력하지 않고 종료되어 버리니 이점에 유의해야 한다.</p>
<p>Dockerrun.aws.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"AWSEBDockerrunVersion"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"volumes"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"log"</span>,</span><br><span class="line">      <span class="attr">"host"</span>: &#123;</span><br><span class="line">        <span class="attr">"sourcePath"</span>: <span class="string">"/var/log"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"containerDefinitions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">      <span class="attr">"image"</span>: <span class="string">"docker.elastic.co/beats/filebeat:6.5.0"</span>,</span><br><span class="line">      <span class="attr">"essential"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"memory"</span>: <span class="number">128</span>,</span><br><span class="line">      <span class="attr">"mountPoints"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"sourceVolume"</span>: <span class="string">"log"</span>,</span><br><span class="line">          <span class="attr">"containerPath"</span>: <span class="string">"/var/log"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"command"</span>: [<span class="string">"--strict.perms=false"</span>],</span><br><span class="line">      <span class="attr">"links"</span>: [<span class="string">"server"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"server"</span>,</span><br><span class="line">      <span class="attr">"image"</span>: <span class="string">"사용자id.dkr.ecr.ap-northeast-2.amazonaws.com/레포이름:latest"</span>,</span><br><span class="line">      <span class="attr">"essential"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"memory"</span>: <span class="number">512</span>,</span><br><span class="line">      <span class="attr">"mountPoints"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"sourceVolume"</span>: <span class="string">"log"</span>,</span><br><span class="line">          <span class="attr">"containerPath"</span>: <span class="string">"/app/log"</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">"portMappings"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">"containerPort"</span>: <span class="number">3001</span>,</span><br><span class="line">          <span class="attr">"hostPort"</span>: <span class="number">80</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="how-does-it-works">how does it works?</span></h3><p>File beat 에는 input 과 harvest 라는 두가지 큰 개념이 있다.</p>
<p>먼저 <strong>input</strong> 이란 filebeat 가 데이터를 읽어오는 리소스를 찾고, 이를 실제로 읽어들이는 harvestor 를 관리하는 역할을 수행한다. 인풋으로 type 이 log 인 인풋이 들어오면 해당하는 패스에서 모든 파일을 찾아 각각에 harvestor 를 작동시킨다.</p>
<p>각 input 은 각자 독자적인 go routine 을 통해 돌아간다.</p>
<p>파일비트는 다음과 같은 종류의 여러 type 의 인풋을 제공한다.</p>
<p>log, stdin, redis, udp, docker, tcp, syslog</p>
<p>example</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">filebeat.inputs:</span></span><br><span class="line"><span class="attr">- type:</span> <span class="string">log</span></span><br><span class="line"><span class="attr">  paths:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/log/*.log</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">/var/path2/*.log</span></span><br></pre></td></tr></table></figure>
<p><strong>harvestor</strong> 란 파일을 하나하나 읽어서 수집하는 <strong>harvest</strong> 를 수행한다. harvestor는 각 파일을 라인바이 라인으로 읽어서 아웃풋으로 보내며, 파일을 열고 닫으면서 계속 수집을 수행한다. harvestor 가 로그를 수집하는 동안 file을 계속 열어놓는다.</p>
<p>harvestor 를 닫으면 리소스를 할당 해제한다.</p>
<h4><span id="파일의-상태관리는-어떻게-하나">파일의 상태관리는 어떻게 하나?</span></h4><p>파일 비트는 각 파일의 읽기 상태를 레지스트리 파일 디스크에 기록해 두고 계속 트레킹한다.</p>
<p>이를 통해 어디까지 읽었는지 파악하고 output server 와의 연결상태가 불안정하다면 이를 계속 트레킹 하고 빠짐없이 보내준다. 파일비트는 무조건 최소한 한번은 정보가 전달되는 것을 보장하는 대신 대신에 두번 갈수는 있다. 이는 레지스트리에 저장된 값 덕분이다. 데이터가 두번 전송되는 문제는 shutdown_timeout 옵션을 통해 조절 할 수 있다.</p>
<p>가령, 파일비트가 종료되기 전에 시간을 두고 데이터를 전송을 완료하는 등의 동작을 수행하는 것이다.</p>
<p>또한, output으로의 연결 상태가 좋지 않은데 파일이 삭제된다면 이는 유실될 수 있다.</p>
<h2><span id="logstash">logstash</span></h2><p>logstash 는 <strong>data flow engine</strong> 으로써 filebeat, dbms, message que 등 여러 데이터 소스로 부터 데이터를 받아 데이터를 가공하고 정제하는 역할을 수행한다.</p>
<p>Logstash 에는 pipeline 이라는 개념이 있으며, 여러 데이터들에 대해 일련의 작업을 수행하는 pipeline의 합집합으로써 동작한다.</p>
<p>elastic stack 내에서 일반적인 활용도는 각 서버의 filebeat 가 보낸 로그 데이터를 받아 각종 메타 정보를 기입하고 분류하고 정제하여 elastic search 서버로 보내주는 역할을 수행한다.</p>
<p>logstash의 기능은 크게 3가지로 이야기 될 수 있는데 바로 <code>input, filter, output</code> 이다.</p>
<p><strong>먼저 input</strong> 은 데이터가 유입되는 근원지를 설정함으로 파일, 데이터베이스, 메세지 큐, 파일비트 등 데이터 유입 경로를 지정하고 주기적으로 데이터를 받는다.</p>
<p><strong>filter</strong> 단계에서는 받은 데이터를 필터링하고 정제하여 메타데이터를 입히고 데이터를 전처리하는 등을 수행한다.</p>
<p><strong>output</strong> 단계에서는 정제된 데이터를 목적으로 되는 서버로 전달하며 주로 검색엔진인 elastic search 등으로 데이터를 전달한다.</p>
<p>logstash 는 데이터를 정제하는 과정에서 <strong>codec</strong> 을 사용하는데, codec 이란 특정 데이터 소스의 형식에 맞는 데이터를 우리가 원하는 형태로 가공해 주는 역할을 하는 encode decode 를 수행한다고 보면 된다. 가령, nginx 서버에서 생성된 각종 nginx 서버 양식의 로그 데이터를 nginx codec 으로 decode 하여 다시 우리가 원하는 데이터 모델로 재생성 하는 것을 생각하면 된다.</p>
<p>이렇게 재가공된 데이터는 다시 filter 를 통해 분류되어 목적지 output 으로 전달된다.</p>
<h4><span id="installation">installation</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/logstash/logstash:6.6.0</span><br></pre></td></tr></table></figure>
<h4><span id="run">run</span></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it -v ~/pipeline/:/usr/share/logstash/pipeline/ docker.elastic.co/logstash/logstash:6.6.0</span><br></pre></td></tr></table></figure>
<p>여기서 logstash 는 파일비트로 부터 여러번 데이터를 받아 batch size 만큼을 체운 뒤에 elastic search 에 데이터를 전달하기 때문에 즉각적으로 데이터가 전송되지 않아 동작을 확인하기 어려울 수 있다.</p>
<p>가급적 input 에 tcp 를 추가하여 실시간으로 데이터를 확인할 수 있도록 설정해 놓으면 비교적 편리하게 테스트를 진행할 수 있다.</p>
<p>logstash.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 파이프라인 수를 의미한다.</span><br><span class="line"># 더 많은 CPU 를 사용하기 위해 설정한다.</span><br><span class="line">pipeline.workers: 2</span><br><span class="line"></span><br><span class="line"># 배치 사이즈를 설정한다.</span><br><span class="line">pipeline.bath.size: 125</span><br><span class="line"></span><br><span class="line"># 배치 딜레이는 어떤 간격으로 요청하는지 한다.</span><br><span class="line">pipeline.batch.delay: 5</span><br><span class="line"></span><br><span class="line"># config 옵션이 변경되면 보고 감지하는 옵션이다.</span><br><span class="line">config.reload.automatic: false</span><br><span class="line"></span><br><span class="line"># config 변경을 감지하는 주기이다.</span><br><span class="line"># 현재 설정에서는 5초에 한번 감지하는 것으로 되어있다.</span><br><span class="line">config.reload.interval: 5s</span><br></pre></td></tr></table></figure>
<h2><span id="elastic-search">Elastic Search</span></h2><p>Elastic search 는 filebeat 가 수집해온 데이터를 분류하고 서치하는 검색 엔진이다.</p>
<h3><span id="installactio-on-docker">installactio on docker</span></h3><p>elastic search server 를 설치하고 실행한다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> docker.elastic.co/elasticsearch/elasticsearch:6.5.4</span><br></pre></td></tr></table></figure>
<p>docker 를 사용하여 구성을 할때 <code>max virtual memory areas vm.max_map_count [65530] is too low, increase to at least</code> 와 같은 에러가 나올 수 있다.</p>
<p>이는 도커에서 할당하는 최대 가상 메모리가 모자라서 생기는 문제로, 다음과 같은 명령어를 통해 이를 늘려주면 해결된다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<h2><span id="kibana">Kibana</span></h2><p>키바나는 내부적으로 노드서버를 띄우며, 사용자가 수집한 정보를 사용자에게 보여주기 위해 시각화 시켜주며, 사용자를 위한 관리자 대쉬보드를 제공한다.</p>
<p>또한, kibana 는 elastic search 를 조작하기 위한 dev console 또한 제공한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker.elastic.co/kibana/kibana:6.5.4</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  kibana:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">docker.elastic.co/kibana/kibana:6.5.4</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">./kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br></pre></td></tr></table></figure>
<p>다운로드를 받았다면 설치를 풀어주고</p>
<p>exconfig/kibana.yml 의 설정을 해준다.</p>
<p>키바나를 실행하면 Localhost:5601 로 키바나가 붙는다.</p>
<h4><span id="kibana-query">Kibana query</span></h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">POST /inspections/_doc</span><br><span class="line">&#123;</span><br><span class="line">  "business_address":"kwan ak goo",</span><br><span class="line">  "coordinates":&#123;</span><br><span class="line">    "lat":21,</span><br><span class="line">    "lon":-123</span><br><span class="line">  &#125;,</span><br><span class="line">  "score":12</span><br><span class="line">&#125;</span><br><span class="line">POST /inspections/_doc/_bulk</span><br><span class="line">&#123; "index" :&#123; "_id" : 1 &#125; &#125;</span><br><span class="line">&#123;"business_address":"kwan ak goo"&#125;</span><br><span class="line">&#123;"index":&#123;"_id":2&#125;&#125;</span><br><span class="line">&#123;"business_address":"kwan ak goo"&#125;</span><br><span class="line"></span><br><span class="line">GET _search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_all": &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /inspections/_mapping/_doc</span><br><span class="line">PUT /inspections/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  "properties": &#123;</span><br><span class="line">    "business_address":&#123;</span><br><span class="line">      "type":"test",</span><br><span class="line">      "fields" : &#123;</span><br><span class="line">        "keyword" : &#123;</span><br><span class="line">          "type" : "keyword",</span><br><span class="line">          "ignore_above" : 256</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "coordinates":&#123;</span><br><span class="line">      "type":"geo_point"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /inspections/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "range":&#123;</span><br><span class="line">      "score":&#123;</span><br><span class="line">        "gte":11</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations":&#123;</span><br><span class="line">    "inspection_score":&#123;</span><br><span class="line">      "range":&#123;</span><br><span class="line">        "field":"score",</span><br><span class="line">        "ranges":[</span><br><span class="line">          &#123;</span><br><span class="line">            "key":"0-80",</span><br><span class="line">            "from":0,</span><br><span class="line">            "to":80</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "sort":[</span><br><span class="line">    &#123;</span><br><span class="line">      "_geo_distance":&#123;</span><br><span class="line">        "coordinates":&#123;</span><br><span class="line">          "lat":34.322345,</span><br><span class="line">          "lon":-122.234234</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      "order":"asc",</span><br><span class="line">      "unit":"km"</span><br><span class="line">    &#125;  </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /inspections/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match":&#123;</span><br><span class="line">      "business_address":"modified"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /inspections/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match_phrase":&#123;</span><br><span class="line">      "business_address":"kwan"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "highlight":&#123;</span><br><span class="line">    "fields":&#123;</span><br><span class="line">      "business_address":&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /inspections/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "bool":&#123;</span><br><span class="line">      "must":[</span><br><span class="line">        &#123;</span><br><span class="line">          "match_phrase":&#123;</span><br><span class="line">            "business_address":"kwan"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "match_phrase":&#123;</span><br><span class="line">            "business_address":"ak"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      "must_not":[</span><br><span class="line">        &#123;</span><br><span class="line">          "match_phrase":&#123;</span><br><span class="line">            "business_address":"goo"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /inspections/_doc/t061gmgBoJ5OaX9VzeS8</span><br><span class="line">&#123;</span><br><span class="line">  "settings":&#123;</span><br><span class="line">    "index.number_of_shards":1,</span><br><span class="line">    "index.number_of_replicas":0</span><br><span class="line">  &#125;,</span><br><span class="line">  "business_address":"modified"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT /inspections/_doc/t061gmgBoJ5OaX9VzeS8</span><br><span class="line">&#123;</span><br><span class="line">  "settings":&#123;</span><br><span class="line">    "index.number_of_shards":1,</span><br><span class="line">    "index.number_of_replicas":0</span><br><span class="line">  &#125;,</span><br><span class="line">  "business_address":"modified"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">POST /inspections/_doc/0k6Ug2gBoJ5OaX9VzuR6/_update</span><br><span class="line">&#123;</span><br><span class="line">  "settings":&#123;</span><br><span class="line">    "index.number_of_shards":1,</span><br><span class="line">    "index.number_of_replicas":0</span><br><span class="line">  &#125;,</span><br><span class="line">  "business_address":"modified"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET /inspections/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "text":"my email address test1234@example.com"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /inspections/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  "tokenizer": "standard",</span><br><span class="line">  "filter": ["lowercase", "unique"], </span><br><span class="line">  "text":"My my email address test1234@example.com"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/23/docker-시작하기/" itemprop="url">
                Getting started with docker
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-23T02:25:01.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/docker/">docker</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                9 minutes read (About 1288 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <h1><span id="docker-시작하기">Docker 시작하기</span></h1><p>현대의 대부분의 소프트웨어는 클라우드 환경에서 동작하게 되고, 서비스를 잘게 나누어 다양한 클라우드 환경에서 쉽게 배포하고 운영하기 위한 컨테이너 기술의 필요성이 대두되었다. 도커는 운영체제 위에서 프로세스를 독립적으로 실행가능하게 만들어 주는 리눅스 컨테이너 기술이다.</p>
<p>기본적으로 container 라는 환경을 구성하고 그 안에서 docker image를 실행시키는 방식이다.</p>
<p>여기서 docker image는 실행에 필요한 코드 및 패키지 등 모든 필요사항을 가진다.</p>
<p>도커는 운영체제 위에서 동작하며 같은 커널에서 어플리케이션이 동작하지만 메모리나 OS 등이 완벽하게 격리될 수 있다.</p>
<h2><span id="installation">Installation</span></h2><p>아래와 같이 brew 로 docker 를 설치하고, 권한을 할당하여 sudo 없이 docker 를 실행 할 수 있게 해준다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install docker docker-compose docker-machine &amp;&amp;</span><br><span class="line">sudo chmod 666 /var/run/docker.sock</span><br></pre></td></tr></table></figure>
<p>먼저 도커를 실행하면 도커 엔진이 실행되며 도커 이미지를 도커 엔진이 실행하면 컨테이너가 생성된다.</p>
<p>먼저 container를 설정하기 위해서 우리는 dockerfile을 작성해야 하는데 기본적인 dockerfile의 형태는 다음과 같다.</p>
<p>Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set node.js environment</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">8</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># set working directory</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /user/src/app</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># 앱 의존성 설치</span></span></span><br><span class="line"><span class="bash">COPY package*.json ./</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># docker image안에 앱의 소스코드를 넣음</span></span></span><br><span class="line"><span class="bash">COPY . .</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">RUN npm install</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Make port 80 available to the world outside this container</span></span></span><br><span class="line"><span class="bash">EXPOSE 8080</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Define environment variable</span></span></span><br><span class="line"><span class="bash">ENV NAME World</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Run app.py when the container launches</span></span></span><br><span class="line"><span class="bash">CMD [<span class="string">"npm"</span>,<span class="string">"start"</span>]</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># RUN chmod +x ./docker-entry.sh</span></span></span><br><span class="line"><span class="bash"><span class="comment"># ENTRYPOINT "./docker-entry.sh"</span></span></span><br></pre></td></tr></table></figure>
<p>그 뒤에 다음 명령어를 통해 docker image를 만들어 준다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t test . // image의 별명을 입력받아 docker image를 만들어 준다.</span><br><span class="line">docker image ls // 이미지의 목록을 불러온다.</span><br></pre></td></tr></table></figure>
<p>앱 실행하기</p>
<p>다음 명령어를 통해 해당 machine의 4000번 포트를 외부 80번 포트에 연결해 준다.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 4000:80 -d test # test 라는 이미지를 실행한다.</span><br></pre></td></tr></table></figure>
<p>Docker container 중지하기</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container stop __container_name_or_id__</span><br></pre></td></tr></table></figure>
<p>docker 로그인 하기</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure>
<p>Docker image  배포하기</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker image tag 붙이기</span></span><br><span class="line">docker tag image username/repository:tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> docker 배포하기</span></span><br><span class="line">docker push username/repository:tag</span><br></pre></td></tr></table></figure>
<p>도커 허브의 이미지 받아서 실행하기</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p <span class="number">4000</span>:<span class="number">80</span> username/repository:tag</span><br></pre></td></tr></table></figure>
<p>지우기</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker container rm __image_id__</span><br></pre></td></tr></table></figure>
<p>모든 도커 컨테이너 삭제</p>
<p><code>docker rm $(docker ps -a -q)</code></p>
<p>모든 도커 이미지 삭제</p>
<p><code>docker rmi $(docker images -q)</code></p>
<p>실행중인 컨테이너의 쉘에 접근</p>
<p><code>docker exec -it container_id /bin/bash</code></p>
<p>docker 실행하면서 bash 실행하기</p>
<p><code>docker run -p 80:80 -it {컨테이너 이름} /bin/bash</code></p>
<h2><span id="docker-network">Docker network</span></h2><p>아래 옵션을 주면 네트워크 포트가 매핑된다.</p>
<p>하지만 아래와 같은 host 네트워크는 리눅스 운영체제에서만 동작하고 mac 이나 window 환경에서는 호스트의 포트에 매핑이 되지 않으니 주의하여야 한다.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --network host</span><br></pre></td></tr></table></figure>
<h2><span id="docker-compose">Docker Compose</span></h2><p>container 내에서 여러개의 image가 돌아야 하고 서비스가 복잡해 질수록 많은 이미지들을 관리해야할 필요가 생기게 된다. 여기서 docker-compose.yml을 사용한다.</p>
<p>즉, docker compose 는 여러개의 도커 컨테이너가 동작하기 위한 방법을 기술한 것이다.</p>
<p>Docker-compose.yml 파일은 docker container가 배포 환경에서 어떻게 동작해야 할지 명시한다.</p>
<p>docker compose의 동작 순서는 다음과 같다.</p>
<ol>
<li>dockerfile 과 함께 어플리케이션의 환경을 정의하여 어디에든 배포할 수 있도록 설정한다.</li>
<li>docker compose 파일에 서비스들을 정의하여 독립된 환경에서 함께 실행될 수 있도록 한다.</li>
<li>docker compose 를 실행시킨다.</li>
</ol>
<p>docker-compose example</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3'</span></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">     - <span class="string">"5000:5000"</span></span><br><span class="line">  redis:</span><br><span class="line">    image: <span class="string">"redis:alpine"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br><span class="line">docker <span class="built_in">stack</span> deploy -c docker-compose.yml getstartedlab</span><br><span class="line">doocker service ls</span><br></pre></td></tr></table></figure>
<p>앱과 swarm을 내리기</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">stack</span> rm getstartedlab</span><br><span class="line">docker swarm leave --force</span><br></pre></td></tr></table></figure>
<p>여기서 swarm 이란 여러 서버에서 동작하는 앱처럼 분산환경에서 배포하기 위한 것이다. 여러 대의 machine을 swarm 이라 불리는 dockerized cluster로 합쳐준다.</p>
<p>swarm을 실행하면 전체 노드들의 관리자로써 swarm을 통제할 수 있게 된다.</p>
<p>다음은 해당 machine을 swarm의 관리자로 임명하고 초기화하는 명령어이다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init</span><br></pre></td></tr></table></figure>
<p>Docker-machine을 통해 virtual machine을 생성할 수 있는 hypervisor를 만들 수 있다.</p>
<p>아래 명령어를 docker-machine을 통해 vm들을 생성하는 명령어이다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-machine create --driver virtualbox myvm1</span><br><span class="line">docker-machine create --driver virtualbox myvm2</span><br><span class="line">docker-machine ls</span><br></pre></td></tr></table></figure>
<p>다음 명령어를 통해 특정 vm이 swarm의 manager가 되도록 한다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh myvm1 <span class="string">"docker swarm init --advertise-addr &lt;myvm1 ip&gt;"</span></span><br></pre></td></tr></table></figure>
<p>특정 vm이 swarm에 참여하도록 하려면 다음 명령어를 수행한다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh myvm2 <span class="string">"docker swarm join \</span></span><br><span class="line"><span class="string">--token &lt;token&gt; \</span></span><br><span class="line"><span class="string">&lt;ip&gt;:2377"</span></span><br></pre></td></tr></table></figure>
<p>swarm에 포함된 node 들을 보는 명령어는 다음과 같다.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-machine ssh myvm1 <span class="string">"docker node ls"</span></span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/23/getting-started-with-machine-learning-with-python/" itemprop="url">
                Getting started with machine learning with python
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-23T02:25:01.000Z" itemprop="datePublished">
                5 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/machine-learning/">machine learning</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                2 minutes read (About 231 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <p>One example of where this handcoded approach will fail is in detecting faces in images. Today, every smartphone can detect a face in an image. </p>
<p>The most successful kinds of machine learning algorithms are those that automate decision-making processes by generalizing from known examples </p>
<p>In this setting, which is known as <em>supervised learning</em></p>
<p>the user provides the algorithm with pairs of inputs and desired outputs, and the algorithm finds a way to produce the desired output given an input.</p>
<p><code>scikit-learn</code> is a very popular tool, and the most prominent Python library for machine learning.</p>
<p>A Python distribution made for large-scale data processing, predictive analytics, and scientific computing</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install numpy scipy matplotlib ipython scikit-learn pandas pillow</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scikit-learn` is built on top of the NumPy and SciPy scientific Python libraries. In addition to NumPy and SciPy, we will be using `pandas` and `matplotlib</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">x = np.array([[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line">print(<span class="string">"x:\n&#123;&#125;"</span>.format(x))</span><br></pre></td></tr></table></figure>
<p><code>pandas</code> is a Python library for data wrangling and analysis</p>
<h4><span id="classification">classification</span></h4><p>어떤 데이터들을 분류하는 문제이다.</p>
<p>여기서 분류의 대상의 data, 분류종류를 class 그리고 특정 데이터가 분류되었을때 그 분류 이름을 label이라고 부른다.</p>

                        
    </div>
    
            
</article>



        
    
        <article class="article content gallery" itemscope="" itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
            <a href="/2019/01/18/supertest-를-활용한-typescript-기반-node-js-e2e-테스트/" itemprop="url">
                supertest 를 활용한 typescript 기반 node.js e2e 테스트
            </a>
            
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <time datetime="2019-01-18T08:59:39.000Z" itemprop="datePublished">
                6 months ago
            </time>
        </span>
        
            <span class="column is-narrow article-category">
                <i class="far fa-folder"></i>
                <a class="article-category-link" href="/categories/supertest/">supertest</a><span>></span><a class="article-category-link" href="/categories/supertest/typescript/">typescript</a>
            </span>
            
                
                    <span class="column is-narrow">
                        
                            
                                12 minutes read (About 1850 words)
                    </span>
                    
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
                    <!--toc-->
<h2><span id="what-is-supertest">What is supertest</span></h2><p>Node.js 에서 express 를 이용하여 서버를 개발함에 있어, rest api 를 테스트 하기 위해서는 실제로 서버에 요청을 보내고 클라이언트에 원하는 데이터가 전송되는 것을 확인해야 한다.</p>
<p>이러한 e2e 테스트를 위해서는 실제 서버를 띄운 뒤에 해당 서버로 요청을 날려 보면서 테스트를 진행해야 하며, 이렇게 가상의 서버를 띄워주고 express web server 에 대해 e2e 테스트를 가능하게 해주는 것이 바로 <code>supertest</code> 이다.</p>
<p>본 포스트에서는 그 중에서도 일반 <code>javascript</code>가 아닌 <code>typescript</code> 환경에서의 e2e 테스트 코드 작성법에 대해 알아보고자 하며, 테스트를 위해서는 페이스북에서 만든 잘나가는 프레임웍인 <code>jest</code>와 <code>typescript 배포판인 ts-jest</code> 를 사용한다.</p>
<h2><span id="prerequisition">Prerequisition</span></h2><p>먼저 타입스크립트로 작성된 프로그램은 javascript 기반의 테스트 환경인 jest 로는 테스트를 작동시킬 수가 없기 때문에, ts-jest 패키지를 dev 환경에 설치해 주어야 jest 가 <code>typescript</code> 코드를 읽고 실행할 수 있다.  </p>
<p>다음과 같이 <code>ts-ject</code>, <code>supertest</code>, <code>@types/supertest</code>를 설치해 준다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev ts-jest</span><br><span class="line">npm install --save-dev supertest</span><br><span class="line">npm install --save-dev @types/supertest</span><br></pre></td></tr></table></figure>
<p>여기서 한가지 문제가 있는데, 아직 typescript supertest 의 경우 여러 패키지들과의 문제를 보이고 있다.</p>
<p>단편적인 예로 XMLHttpRequest 를 찾지 못하는 현상이 있는데, 이는 다음 설정을 tsconfig.json 에 해줌으로써 해결된다.<br>다음과 같이 dom 을 앞에다 추가해 주자. <strong>반드시 첫번째로 해야한다.</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    compilerOptions:&#123;</span><br><span class="line">        &quot;lib&quot;:[&quot;dom&quot;,&quot;es2015]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>위처럼 ts-jest를 설치했다면 이제 typescript 코드를 jest 에서 돌릴수 있게 된다.</p>
<p>본 프로젝트에서는 ts-jest 는 내부적으로 js 의 es6 문법을 컴파일 하기 위해 babel loader 를 사용하기 때문에 다음과 같이 babel env 를 설치하고 babel configuration 을 다음과 같이 해주어야 한다.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev babel-preset-env</span><br></pre></td></tr></table></figure>
<p>.babelrc</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    presets:["env"]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4><span id="setup-jest-configuration">Setup jest configuration</span></h4><p>Jest 세팅은 tsconfig.json 에서도 할 수 있고 jest.config.js 파일에서도 할 수 있다.</p>
<p>이 경우 반드시 한쪽에서만 해야 문제가 발생하지 않기때문에 유념한다.</p>
<p>Jest 는 typescript 를 컴파일 하지 않고 파일별로 컴파일과 실행을 동시에 처리하기 때문에, module alias 를 사용하였다면, 해당 파일이 어디에 있는지를 가르쳐 주어야 한다.</p>
<p>아래 코드에서는 moduleNameMapper 를 통해 module alias 를 발견하면 어디에서 해당 파일을 찾을 수 있는지 jest 에게 가르쳐 준다.</p>
<p>또한 ts-jest preset 를 사용한다는 것을 명시하고 있다.</p>
<p>jest.config.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  preset: <span class="string">'ts-jest'</span>,</span><br><span class="line">  testEnvironment: <span class="string">'node'</span>,</span><br><span class="line">  moduleNameMapper: &#123;</span><br><span class="line">    <span class="string">'^@domain/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/domain/$1'</span>,</span><br><span class="line">    <span class="string">'^@common/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/common/$1'</span>,</span><br><span class="line">    <span class="string">'^@utils/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/utils/$1'</span>,</span><br><span class="line">    <span class="string">'^@infra/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/infra/$1'</span>,</span><br><span class="line">    <span class="string">'^@api/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/api/$1'</span>,</span><br><span class="line">    <span class="string">'^@interfaces/(.*)$'</span>: <span class="string">'&lt;rootDir/src/server/interfaces/$1'</span>,</span><br><span class="line">    <span class="string">'^@root/(.*)$'</span>: <span class="string">'&lt;rootDir&gt;/src/server/$1'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  transform: &#123;</span><br><span class="line">    <span class="string">'^.+\\.jsx?$'</span>: <span class="string">'babel-jest'</span>,</span><br><span class="line">    <span class="string">'^.+\\.(ts|tsx)$'</span>: <span class="string">'ts-jest'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  moduleFileExtensions: [<span class="string">'ts'</span>, <span class="string">'tsx'</span>, <span class="string">'js'</span>, <span class="string">'node'</span>, <span class="string">'json'</span>],</span><br><span class="line">  testMatch: [<span class="string">'**/*.test.+(ts|tsx|js)'</span>]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>여기서 moduleFileExtensions의 경우 typescript 테스트만을 진행하는 경우에는 tx, tsx, js 만 명시해주어도 되지만, 기본적인 node 가 제공하는 확장자인 json, node 등도 추가하여야 여러 패키지를 사용함에 있어 문제가 없다.</p>
<h2><span id="getting-started">Getting started</span></h2><h4><span id="how-to-setup-express-application">how to setup express application</span></h4><p>Supertest 는 express application 객체를 받아서 내부적으로 서버를 listen 하기 때문에 supertest를 할 때마다 이런 express application을 주입시켜 주어야 한다. 어찌보면 단순한 일이지만 사실 실제 서버의 경우 express application 을 초기화하는 일련의 과정이 존재하기 때문에 이 작업을 해주는 것이 다소 까다로울 수 있다.</p>
<p>또한, 대부분의 REST API 테스트의 경우 인증된 사용자에 대해서만 요청을 처리하는 authentication 기능이 있기 때문에, 테스트를 진행하기 전에 jwt 토큰 발급 및 회원가입 등 authentication 관련 문제들을 해결해야 한다.</p>
<p>때문에, 본 문서에서는 이런 <code>기본적인 express application initializing 과 authentication 을 도와주는 helper 클래스인 TestHelper 클래스</code>를 먼저 구현하여 supertest 를 하도록 한다.</p>
<p>app.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> App &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">async</span> setup(): <span class="built_in">Promise</span>&lt;express.Express&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> app = express();</span><br><span class="line">        app.use();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> app;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>testHelper.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> TestHelper &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 테스트에 필요한 유저를 만들어 주는 함수이다.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param id 유저의 아이디</span></span><br><span class="line"><span class="comment">   * @param password 유저의 비밀번호</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> generateTestUser(</span><br><span class="line">    id: <span class="built_in">string</span>,</span><br><span class="line">    password: <span class="built_in">string</span></span><br><span class="line">  ): <span class="built_in">Promise</span>&lt;User&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 필자는 일련의 회원가입을 담당하는 userService 에서 </span></span><br><span class="line"><span class="comment">     * 회원가입을 처리하고 있다.</span></span><br><span class="line"><span class="comment">     * 이 부분은 독자가 임의적으로 회원가입 로직을 구현하면 된다.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> userService.createUser(</span><br><span class="line">      id,</span><br><span class="line">      password</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * @param id 유저의 아이디</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> generateJwt(id) &#123;</span><br><span class="line">    <span class="keyword">let</span> jwtPayload = <span class="keyword">new</span> JwtPayload(id);</span><br><span class="line">    <span class="keyword">return</span> encodeJwt(jwtPayload);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">async</span> getApp(): <span class="built_in">Promise</span>&lt;express.Express&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> APP = <span class="keyword">new</span> App();</span><br><span class="line">    <span class="keyword">let</span> app = <span class="keyword">await</span> APP.setup();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> testHelper = <span class="keyword">new</span> TestHelper();</span><br></pre></td></tr></table></figure>
<p>위처럼 express appilcation 을 비동기적으로 세팅해주는 helper 함수들을 구현하였다면 아래와 같이 모든 테스트 코드를 작성하기 전에 위의 app을 초기화 해준다.</p>
<p>모든 테스트 이전에 다양한 환경을 세팅해주기 위해 <code>beforeAll()</code> 를 이용하는데, 이는 모든 테스트 전에 해야할 일들을 명시하고 세팅해 준다. 만약, <code>비동기적인 작업을 beforeAll 에서 해야 할 필요가 있다면</code> 다음과 같은 방법이 있다.</p>
<ol>
<li>Promise 를 return 해주는 방법</li>
<li>Async/Await 을 사용하는 방법</li>
<li>Done 인자를 받아 사용하는 방법</li>
</ol>
<p>아래 코드에서<code>before all 부분에서 바로 promise 를 리턴</code>하는 방식과 <code>Async/Await</code> 방식을 보여주고 있다.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'return promise'</span>,<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> app;</span><br><span class="line">    </span><br><span class="line">    beforeAll(<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> testHelper.getApp().then(_app=&gt;&#123;</span><br><span class="line">            app = _app;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    describe(<span class="string">'POST: /users'</span>,<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> request(app).post(<span class="string">'api/v1/users'</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line">describe(<span class="string">'example test'</span>,<span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> app;</span><br><span class="line">    </span><br><span class="line">    beforeAll(<span class="keyword">async</span>()=&gt;&#123;</span><br><span class="line">        app = <span class="keyword">await</span> testHelper.getApp()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    describe(<span class="string">'POST: /users'</span>,<span class="keyword">async</span>()=&gt;&#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> request(app).post(<span class="string">'api/v1/users'</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>이렇게 테스트를 돌리게 되면, <strong>테스트는 끝이 났는데 프로세스는 계속해서 동작하고 있다는 에러를 볼 수 있다.</strong></p>
<p>이는 데이터베이스 등처럼 connection 객체가 살아있는 경우 해당 프로세스가 종료되지 않기 때문인데, 이 때문에 다음과 같이 테스트가 끝난 이후에 <code>application</code> 내의 데이터베이스 커넥션을 끊어주면 해당 경고가 없어진다.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">''</span>,()=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> app;</span><br><span class="line">    </span><br><span class="line">    beforeAll(<span class="keyword">async</span>()=&gt;&#123;</span><br><span class="line">        app = <span class="keyword">await</span> testHelper.getApp()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    afterAll(<span class="keyword">async</span>()=&gt;&#123;</span><br><span class="line">        app.closeApp()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4><span id="여러-파일에서의-beforeall-작업">여러 파일에서의 beforeAll 작업</span></h4><p>위처럼 모든 테스트파일에서 setup 을 진행하면, 각 setup 은 jest 의 특성상 비동기적으로 동작하게 되기 때문에, 만약 db 등을 조작한다면 confict 이 날 수 있다.</p>
<p>즉, 만약 모든 테스트를 통틀어 한번 데이터를 세팅하고자 한다면 다음과 같이 별도의 setup.js 파일을 만들어 전체 테스트 실행 전에 돌려주는 것이 좋다.</p>
<p>setup.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mysql = <span class="built_in">require</span>(<span class="string">'mysql'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(mysql);</span><br><span class="line"><span class="keyword">var</span> connection = mysql.createConnection(&#123;</span><br><span class="line">  host: <span class="string">'localhost'</span>,</span><br><span class="line">  user: <span class="string">'root'</span>,</span><br><span class="line">  password: <span class="string">'test1234'</span>,</span><br><span class="line">  database: <span class="string">'test'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">connection.connect();</span><br><span class="line"></span><br><span class="line">connection.query(<span class="string">'DELETE FROM user;'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">error, results, fields</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">throw</span> error;</span><br><span class="line">&#125;);</span><br><span class="line">connection.end();</span><br></pre></td></tr></table></figure>
<p>위 스크립트 파일을 시작하도록 package.json 에 등록해준다.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"scripts"</span>:&#123;</span><br><span class="line">        <span class="attr">"test"</span>:<span class="string">"node ./setup.js &amp;&amp; jest"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                        
    </div>
    
            
</article>



        
    
    
        
<nav class="pagination is-centered is-rounded" role="navigation" aria-label="pagination">
    <div class="pagination-previous">
        <a href="/page/3/">Prev</a>
    </div>
    <div class="pagination-next">
        <a href="/page/5/">Next</a>
    </div>
    <ul class="pagination-list is-hidden-mobile">
        
        <li><a class="pagination-link" href="/">1</a></li>
        
        <li><a class="pagination-link" href="/page/2/">2</a></li>
        
        <li><a class="pagination-link" href="/page/3/">3</a></li>
        
        <li><a class="pagination-link is-current" href="/page/4/">4</a></li>
        
        <li><a class="pagination-link" href="/page/5/">5</a></li>
        
        <li><span class="pagination-ellipsis">&hellip;</span></li>
        
        <li><a class="pagination-link" href="/page/23/">23</a></li>
        
    </ul>
</nav>
    
    </div>
</section>

            <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                &copy; 2019 Jake.Lee 이남훈&nbsp;
                Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> & <a href="http://github.com/ppoffice/hexo-theme-minos">Minos</a>
            </div>
            <div class="column is-hidden-mobile"></div>

            
            <div class="column is-narrow">
                <div class="columns is-mobile is-multiline is-centered">
                
                    
                <a class="column is-narrow has-text-black" href="https://github.com/frontalnh">
                    
                    GitHub
                    
                </a>
                
                </div>
            </div>
            
            
        </div>
    </div>
</footer>
                <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        //plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
</script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        "HTML-CSS": {matchFontHeight: false},
        SVG: {matchFontHeight: false},
        CommonHTML: {matchFontHeight: false}
    });
</script>

    
    
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>
    (function ($) {
        $(document).ready(function () {
            if (typeof($.fn.lightGallery) === 'function') {
                $('.article.gallery').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof($.fn.justifiedGallery) === 'function') {
                $('.justified-gallery').justifiedGallery();
            }
        });
    })(jQuery);
</script>

    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110077250-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-110077250-2');
</script>


    


<script src="/js/script.js"></script>

                    
                        <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js"></script>
                            
</body>

</html>